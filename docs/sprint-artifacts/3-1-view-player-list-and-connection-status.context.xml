<story-context id="3-1-view-player-list-and-connection-status" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>View Player List and Connection Status</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-1-view-player-list-and-connection-status.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>see a list of all players currently in the room and their connection status</iWant>
    <soThat>I know who is present and active</soThat>
    <tasks>
      <task id="1">Backend Player Connection Tracking - Update Player model with connected, connected_at, last_activity fields; add update_player_status and get_disconnected_players methods</task>
      <task id="2">Backend Heartbeat/Ping-Pong Mechanism - Add ping event handler, background task for stale connection detection, player_disconnected/reconnected events</task>
      <task id="3">Frontend Ping Client - Create usePing hook for 30-second ping interval</task>
      <task id="4">Frontend Player List Component Enhancement - Add connection status badges (ðŸŸ¢/ðŸ”´), "You" label, join timestamp</task>
      <task id="5">Frontend Socket.io Handlers - Add listeners for player_disconnected, player_reconnected, player_left events</task>
      <task id="6">Frontend Store Enhancement - Add updatePlayerStatus and removePlayer actions</task>
      <task id="7">Frontend Room View Integration - Pass currentPlayerId to PlayerList, start/stop pinging on mount/unmount</task>
      <task id="8">Backend Pydantic Models - Update Player model with connected_at, last_activity fields</task>
      <task id="9">Integration Test - Connection Tracking</task>
      <task id="10">Integration Test - Broadcasting</task>
      <task id="11">E2E Test - Connection Status Changes with 2 concurrent browsers</task>
      <task id="12">Manual Testing and Documentation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Player list visible in Room View showing all players with names</criterion>
    <criterion id="AC2">Each player has connection status badge (ðŸŸ¢ connected, ðŸ”´ disconnected)</criterion>
    <criterion id="AC3">Current user highlighted in player list (e.g., "You" label)</criterion>
    <criterion id="AC4">When player disconnects from WebSocket, status changes to "disconnected" within 2 seconds</criterion>
    <criterion id="AC5">When disconnected player reconnects, status changes back to "connected" within 2 seconds</criterion>
    <criterion id="AC6">Player leaves room â†’ removed from list (player_left event)</criterion>
    <criterion id="AC7">New player joins room â†’ added to list with "connected" status</criterion>
    <criterion id="AC8">Player list updates in real-time for all room members</criterion>
    <criterion id="AC9">Ping/pong heartbeat detects disconnections faster than default (every 30 seconds)</criterion>
    <criterion id="AC10">E2E test validates connection status changes with 2 concurrent browsers</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Overview</title>
        <section>Technology Stack, System Architecture</section>
        <snippet>Socket.io with native room concept for real-time features. Zustand for global state management with Socket.io integration. Valkey (Redis fork) with single-hash-per-room pattern.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Product Epics and Stories</title>
        <section>Epic 3: Session Management and Presence</section>
        <snippet>Story 3.1: View Player List and Connection Status - displays list of all players with online/offline status indicators.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Player Model, Socket.io Events</section>
        <snippet>Player model has player_id, name, connected fields. Socket events: player_joined, room_state, room_created, room_joined.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>backend/src/sdd_process_example/models.py</path>
        <kind>model</kind>
        <symbol>Player, RoomState, DiceResult</symbol>
        <lines>1-60</lines>
        <reason>Player model already has connected: bool field. Needs connected_at and last_activity fields added.</reason>
      </file>
      <file>
        <path>backend/src/sdd_process_example/services/room_manager.py</path>
        <kind>service</kind>
        <symbol>RoomManager</symbol>
        <lines>1-300</lines>
        <reason>Core room management. Needs update_player_status and get_disconnected_players methods added.</reason>
      </file>
      <file>
        <path>backend/src/sdd_process_example/socket_manager.py</path>
        <kind>event-handler</kind>
        <symbol>connect, disconnect, create_room, join_room</symbol>
        <lines>1-200</lines>
        <reason>Socket.io event handlers. Needs ping/pong handlers and player_disconnected/reconnected event emission.</reason>
      </file>
      <file>
        <path>frontend/src/components/PlayerList.tsx</path>
        <kind>component</kind>
        <symbol>PlayerList</symbol>
        <lines>1-120</lines>
        <reason>Already has connection status badges (ðŸŸ¢/ðŸ”´), "You" label. May need minor enhancements.</reason>
      </file>
      <file>
        <path>frontend/src/store/socketStore.ts</path>
        <kind>store</kind>
        <symbol>useSocketStore, SocketState</symbol>
        <lines>1-130</lines>
        <reason>Zustand store with players array. Needs updatePlayerStatus and removePlayer actions.</reason>
      </file>
      <file>
        <path>frontend/src/hooks/useSocket.ts</path>
        <kind>hook</kind>
        <symbol>useSocket</symbol>
        <lines>1-250</lines>
        <reason>Socket.io event listeners. Needs player_disconnected, player_reconnected event handlers.</reason>
      </file>
      <file>
        <path>frontend/src/pages/RoomView.tsx</path>
        <kind>page</kind>
        <symbol>RoomView</symbol>
        <reason>Main room page. Needs ping hook integration on mount/unmount.</reason>
      </file>
    </code>

    <dependencies>
      <backend>
        <package name="python-socketio" version="5.10+">Real-time WebSocket server</package>
        <package name="redis" version="5.0+">Room state storage</package>
        <package name="asyncio" version="builtin">Background heartbeat task</package>
      </backend>
      <frontend>
        <package name="socket.io-client" version="4.8.1">Real-time WebSocket client</package>
        <package name="zustand" version="5.0.8">Global state management</package>
        <package name="react" version="18.2+">UI library</package>
        <package name="lucide-react" version="0.554.0">Icons (Users icon for player list)</package>
      </frontend>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>Player Model</name>
      <kind>Pydantic Model</kind>
      <signature>class Player(BaseModel): player_id: str, name: str, connected: bool = True, connected_at: datetime | None = None, last_activity: datetime | None = None</signature>
      <path>backend/src/sdd_process_example/models.py</path>
    </interface>
    <interface>
      <name>ping Socket Event</name>
      <kind>Socket.io Event</kind>
      <signature>socket.emit('ping', { player_id: string }) â†’ server emits 'pong'</signature>
      <path>frontend/src/hooks/usePing.ts (NEW)</path>
    </interface>
    <interface>
      <name>player_disconnected Socket Event</name>
      <kind>Socket.io Broadcast</kind>
      <signature>server.emit('player_disconnected', { player_id: string, player_name: string }) to room</signature>
      <path>backend/src/sdd_process_example/socket_manager.py</path>
    </interface>
    <interface>
      <name>player_reconnected Socket Event</name>
      <kind>Socket.io Broadcast</kind>
      <signature>server.emit('player_reconnected', { player_id: string, player_name: string }) to room</signature>
      <path>backend/src/sdd_process_example/socket_manager.py</path>
    </interface>
    <interface>
      <name>update_player_status</name>
      <kind>RoomManager Method</kind>
      <signature>def update_player_status(room_code: str, player_id: str, connected: bool) -> None</signature>
      <path>backend/src/sdd_process_example/services/room_manager.py</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint>Heartbeat interval: 30 seconds (configurable)</constraint>
    <constraint>Stale timeout: 90 seconds (player marked disconnected if no pong)</constraint>
    <constraint>Detection delay: Within 2 seconds for status changes</constraint>
    <constraint>Disconnected state: Player remains in room (allows reconnection)</constraint>
    <constraint>Explicit leave: Player removed from room immediately</constraint>
    <constraint>ADR-002: Socket.io for all real-time features</constraint>
    <constraint>ADR-003: Redis single-hash-per-room pattern</constraint>
    <constraint>ADR-006: Zustand for global state management</constraint>
    <constraint>ADR-007: Tailwind CSS for styling</constraint>
    <constraint>TDD: Write tests before implementation</constraint>
  </constraints>

  <tests>
    <standards>
      Backend: Pytest with pytest-asyncio for async tests. 80% coverage target.
      Frontend: Vitest with Testing Library for component tests.
      E2E: Playwright for multi-browser tests.
      TDD: Red-Green-Refactor cycle required.
    </standards>
    <locations>
      <location>backend/tests/</location>
      <location>frontend/src/tests/</location>
      <location>frontend/src/components/__tests__/</location>
      <location>frontend/e2e/</location>
    </locations>
    <ideas>
      <idea acId="AC1">Component test: PlayerList renders all players with names</idea>
      <idea acId="AC2">Component test: PlayerList shows ðŸŸ¢ for connected, ðŸ”´ for disconnected</idea>
      <idea acId="AC3">Component test: Current player has "You" badge</idea>
      <idea acId="AC4">Integration test: Player disconnect â†’ status changes within 2s</idea>
      <idea acId="AC5">Integration test: Player reconnect â†’ status changes within 2s</idea>
      <idea acId="AC6">Integration test: player_left event removes player from list</idea>
      <idea acId="AC7">Integration test: player_joined event adds player with connected status</idea>
      <idea acId="AC8">E2E test: Two browsers see real-time updates</idea>
      <idea acId="AC9">Unit test: Ping hook emits ping every 30 seconds</idea>
      <idea acId="AC10">E2E test: Browser A disconnects, Browser B sees status change</idea>
    </ideas>
  </tests>
</story-context>
