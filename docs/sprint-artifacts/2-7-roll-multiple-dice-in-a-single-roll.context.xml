<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>7</storyId>
    <title>Roll Multiple Dice in a Single Roll</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-7-roll-multiple-dice-in-a-single-roll.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>roll multiple dice of the same type in one roll (e.g., 3d6, 8d10, 20d6)</iWant>
    <soThat>I can efficiently roll damage or ability scores</soThat>
    <tasks>
      - Backend dice parser already supports multiple dice (COMPLETE - via Story 2.5)
      - AdvancedDiceInput quantity control already implemented (Story 2.5)
      - Verify RollHistory displays all individual die results clearly
      - Add visual grouping for large quantities (e.g., 20d6 fireball)
      - Optimize display for 10+ individual results (scrolling or collapse)
      - Write E2E test for 3d6 roll (damage)
      - Write E2E test for 20d6 roll (fireball damage with many dice)
      - Write E2E test verifying all individual results appear in history
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Backend correctly rolls multiple dice (ALREADY DONE via Story 2.5)
    2. User can specify quantity 1-100 in AdvancedDiceInput (ALREADY DONE)
    3. Roll history displays all individual die results clearly
    4. Large quantities (10+) display with visual grouping or collapse
    5. Formula shows quantity prominently (e.g., "3d6", "20d6")
    6. Total is sum of all individual results
    7. E2E test validates 3d6 roll shows 3 individual results
    8. E2E test validates 20d6 roll shows 20 individual results
    9. Performance acceptable even with 100d6 (extreme case)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Core Dice Rolling</title>
        <section>Multiple Dice Notation</section>
        <snippet>Backend parser supports NdM notation. Validates up to 100 dice per roll. Returns all individual results as array.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>frontend/src/components/RollHistory.tsx</path>
        <kind>component</kind>
        <symbol>RollHistory</symbol>
        <lines>1-95</lines>
        <reason>May need UI optimization for displaying 10+ individual results (visual grouping or collapse/expand).</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/AdvancedDiceInput.tsx</path>
        <kind>component</kind>
        <symbol>AdvancedDiceInput</symbol>
        <lines>N/A</lines>
        <reason>Quantity input already implemented in Story 2.5. Verify it works for multiple dice rolls.</reason>
      </artifact>
    </code>
    <dependencies>
      <npm>
        <package name="react" version="^18.2.0" />
        <package name="socket.io-client" version="^4.8.1" />
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    - NO backend changes needed - multiple dice already supported
    - Frontend verification story ensuring UI handles multiple dice well
    - Must display ALL individual die results (no hiding)
    - Large quantities (10+) should have visual grouping for readability
    - Performance must remain acceptable with 100d6 rolls
    - Formula display must be clear: "3d6+2" = 3 dice, size 6, modifier +2
  </constraints>

  <interfaces>
    <interface>
      <name>RollResult with Multiple Dice</name>
      <kind>Data Model</kind>
      <signature>
{
  roll_id: "uuid",
  formula: "3d6+2",
  individual_results: [4, 5, 6],  // all 3 results
  modifier: 2,
  total: 17  // (4+5+6) + 2
}
      </signature>
      <path>frontend/src/store/socketStore.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>E2E tests for multiple dice quantities. Verify all individual results display correctly.</standards>
    <locations>
      - frontend/e2e/multiple-dice.spec.ts (NEW)
    </locations>
    <ideas>
      <test ac="7" desc="E2E test: Roll 3d6, verify 3 individual results shown">test_3d6_roll</test>
      <test ac="8" desc="E2E test: Roll 20d6, verify all 20 results shown">test_20d6_fireball</test>
      <test ac="9" desc="E2E test: Roll 100d6, verify performance acceptable">test_100d6_performance</test>
      <test ac="3,4" desc="Visual test: 10+ dice display with visual grouping">test_large_quantity_display (manual)</test>
    </ideas>
  </tests>
</story-context>
